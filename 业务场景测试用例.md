# 业务场景测试用例

> 本文档提供两个典型业务场景的完整测试用例，供前端开发者对接后进行调试验证

---

## 🧪 测试准备

### 环境配置

```bash
# 确认后端服务运行
curl http://localhost:3000/health
# 期望响应: {"status":"ok","timestamp":1697270000.123}

# 查看 API 文档
open http://localhost:3000/docs
```

### 测试账号

| 角色 | 用户名 | 密码 | 用途 |
|------|--------|------|------|
| 普通用户 | `testuser_5090` | `8lpcUY2BOt` | 测试场景一 |
| 开发者 | `devuser_5090` | `mryuWTGdMk` | 测试场景二 |

---

## 📋 场景一：普通用户语音交互

### 测试目标
验证用户通过语音发布指令，系统理解意图、调用工具并返回结果的完整流程

### 测试步骤

#### Step 1: 用户登录

**请求**：
```bash
curl -X POST "http://localhost:3000/api/v1/auth/token" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=testuser_5090&password=8lpcUY2BOt"
```

**期望响应**：
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer",
  "role": "user"
}
```

**前端处理**：
```javascript
// 保存 token
localStorage.setItem('token', response.access_token);
localStorage.setItem('role', response.role);
```

---

#### Step 2: 意图解析（直接回答场景）

**场景描述**：用户问候或闲聊，不需要调用工具

**请求**：
```bash
TOKEN="YOUR_ACCESS_TOKEN"

curl -X POST "http://localhost:3000/api/v1/intent/interpret" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "query": "你好，今天天气不错",
    "session_id": null,
    "user_id": 13
  }'
```

**期望响应**：
```json
{
  "type": "direct",
  "content": "你好！今天确实是个好天气。有什么我可以帮助你的吗？",
  "tool_calls": null,
  "confirm_text": null,
  "session_id": "550e8400-e29b-41d4-a716-446655440000"
}
```

**前端处理**：
```javascript
if (data.type === 'direct') {
  // 直接播报回答
  speakText(data.content);
}
```

---

#### Step 3: 意图解析（工具调用场景）

**场景描述**：用户请求需要调用工具（如查天气、翻译等）

**请求**：
```bash
curl -X POST "http://localhost:3000/api/v1/intent/interpret" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "query": "帮我查询深圳的天气",
    "session_id": null,
    "user_id": 13
  }'
```

**期望响应**：
```json
{
  "type": "tool_call",
  "content": "您想查询深圳的天气信息，我将为您调用天气查询服务。",
  "tool_calls": [
    {
      "tool_id": "maps_weather",
      "tool_name": "天气查询",
      "parameters": {
        "city": "深圳"
      }
    }
  ],
  "confirm_text": "我将为您查询深圳的天气，是否继续？",
  "session_id": "550e8400-e29b-41d4-a716-446655440001"
}
```

**前端处理**：
```javascript
if (data.type === 'tool_call') {
  // 显示确认文本
  displayConfirmation(data.confirm_text);
  // 等待用户确认
  const userConfirm = await getUserInput(); // "是" / "y" / "确认"
  // 继续下一步
}
```

---

#### Step 4: 用户确认执行

**场景描述**：用户确认执行工具调用

**请求**：
```bash
SESSION_ID="550e8400-e29b-41d4-a716-446655440001"

curl -X POST "http://localhost:3000/api/v1/intent/confirm" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "session_id": "'$SESSION_ID'",
    "user_input": "是的，查询吧"
  }'
```

**期望响应（成功执行）**：
```json
{
  "success": true,
  "content": "深圳今天多云，气温25-32°C，湿度75%，东南风3级。",
  "session_id": "550e8400-e29b-41d4-a716-446655440001"
}
```

**期望响应（用户拒绝）**：
```bash
# 用户输入 "不了" / "取消" / "n"
{
  "success": false,
  "content": "好的，已取消操作。还有什么我可以帮您的吗？",
  "session_id": "550e8400-e29b-41d4-a716-446655440001"
}
```

**前端处理**：
```javascript
if (data.success) {
  // 播报结果
  speakText(data.content);
} else {
  // 显示取消消息
  displayMessage(data.content);
}
```

---

### 完整前端示例代码

```javascript
// 场景一：完整的语音交互流程
async function handleVoiceInteraction(userQuery) {
  try {
    const token = localStorage.getItem('token');
    
    // 1. 意图解析
    const interpretResponse = await fetch('http://localhost:3000/api/v1/intent/interpret', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        query: userQuery,
        session_id: null,
        user_id: 13
      })
    });
    
    const interpretData = await interpretResponse.json();
    
    if (interpretData.type === 'direct') {
      // 直接回答，语音播报
      speakText(interpretData.content);
      return;
    }
    
    if (interpretData.type === 'tool_call') {
      // 需要工具调用，显示确认信息
      const userConfirm = await showConfirmDialog(interpretData.confirm_text);
      
      if (!userConfirm) {
        return; // 用户取消
      }
      
      // 2. 确认执行
      const confirmResponse = await fetch('http://localhost:3000/api/v1/intent/confirm', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          session_id: interpretData.session_id,
          user_input: userConfirm ? "是的" : "取消"
        })
      });
      
      const confirmData = await confirmResponse.json();
      
      // 播报结果
      speakText(confirmData.content);
    }
    
  } catch (error) {
    console.error('语音交互失败:', error);
    speakText('抱歉，处理您的请求时出现了问题');
  }
}

// 辅助函数
function speakText(text) {
  // 使用 Web Speech API 播报
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = 'zh-CN';
  speechSynthesis.speak(utterance);
}

function showConfirmDialog(message) {
  return new Promise((resolve) => {
    // 显示确认对话框
    const result = confirm(message);
    resolve(result);
  });
}
```

---

## 📋 场景二：开发者上传 API 集成

### 测试目标
验证开发者提交 Dify/Coze API 配置，系统自动验证、测试连通性并注册的完整流程

### 测试步骤

#### Step 1: 开发者登录

**请求**：
```bash
curl -X POST "http://localhost:3000/api/v1/auth/token" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=devuser_5090&password=mryuWTGdMk"
```

**期望响应**：
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer",
  "role": "developer"
}
```

**验证权限**：
```bash
# 确认用户角色为 developer
TOKEN="YOUR_ACCESS_TOKEN"

curl "http://localhost:3000/api/v1/auth/me" \
  -H "Authorization: Bearer $TOKEN"
```

---

#### Step 2a: 创建 Dify 集成（成功案例）

**场景描述**：开发者提交有效的 Dify API 配置

**请求**：
```bash
curl -X POST "http://localhost:3000/api/v1/dev/integrations" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "客服助手",
    "type": "http",
    "description": "基于 Dify 的智能客服机器人",
    "endpoint": {
      "platform": "dify",
      "api_key": "app-pHV5SsTpD0eAsUpqc2YtZeNs"
    }
  }'
```

curl 'http://localhost:3000/api-proxy/api/v1/dev/integrations' \
  -H 'Accept: application/json, text/plain, */*' \
  -H 'Accept-Language: zh-CN,zh;q=0.9,en;q=0.8,zh-TW;q=0.7,ko;q=0.6' \
  -H 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxIiwidXNlcm5hbWUiOiJkZXZ1c2VyXzUwOTAiLCJyb2xlIjoiZGV2ZWxvcGVyIiwiZXhwIjoxNzYwODUwNjIwfQ.g01WB1fl43AzR32cC9Gi76Igw1gHDE5yPYtciifbvOw' \
  -H 'Cache-Control: no-cache' \
  -H 'Connection: keep-alive' \
  -H 'Content-Type: application/json' \
  -b 'ajs_anonymous_id=%2297e1473c-d318-4e21-b046-c39005eaf565%22; __next_hmr_refresh_hash__=7e8a0154e8118542dfb0fedc91f59989633457081244afec' \
  -H 'Origin: http://localhost:3000' \
  -H 'Pragma: no-cache' \
  -H 'Referer: http://localhost:3000/developer/' \
  -H 'Sec-Fetch-Dest: empty' \
  -H 'Sec-Fetch-Mode: cors' \
  -H 'Sec-Fetch-Site: same-origin' \
  -H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/140.0.0.0 Safari/537.36' \
  -H 'sec-ch-ua: "Chromium";v="140", "Not=A?Brand";v="24", "Google Chrome";v="140"' \
  -H 'sec-ch-ua-mobile: ?0' \
  -H 'sec-ch-ua-platform: "macOS"' \
  --data-raw '{"name":"调研助手","type":"http","description":"当你给出一个公司的名字时候他会给你基本信息","endpoint":{"platform":"dify","api_key":"app-XWcn8Btx1bmpzpGmVkSwOv"}}'

**期望响应**：
```json
{
  "id": 101,
  "tool_id": "dify_1697270123_a1b2c3d4",
  "name": "客服助手",
  "type": "http",
  "description": "基于 Dify 的智能客服机器人",
  "status": "active",
  "endpoint": {
    "platform": "dify",
    "api_key": "app-pHV5SsTpD0eAsUpqc2YtZeNs",
    "base_url": "https://api.dify.ai/v1",
    "app_config": {
      "response_mode": "blocking"
    }
  },
  "request_schema": {
    "type": "object",
    "properties": {
      "query": {
        "type": "string",
        "description": "用户查询内容"
      }
    },
    "required": ["query"]
  },
  "created_at": "2025-10-14T03:42:00Z"
}
```

**前端处理**：
```javascript
if (response.ok) {
  const data = await response.json();
  showSuccess(`集成创建成功！Tool ID: ${data.tool_id}`);
  // 可选：立即测试
  testIntegration(data.id);
}
```

---

#### Step 2b: 创建 Coze 集成（成功案例）

**请求**：
```bash
curl -X POST "http://localhost:3000/api/v1/dev/integrations" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "FAQ 问答助手",
    "type": "http",
    "description": "基于 Coze 的常见问题解答机器人",
    "endpoint": {
      "platform": "coze",
      "api_key": "pat_OYDacMzM3WyOWV3Dtj2bHRMymzxP1234",
      "app_config": {
        "bot_id": "7342866812345"
      }
    }
  }'
```

**期望响应**：类似 Dify 的响应结构

---

#### Step 3: 创建集成（失败案例）

##### 3a. API Key 格式错误

**请求**：
```bash
curl -X POST "http://localhost:3000/api/v1/dev/integrations" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "测试工具",
    "type": "http",
    "endpoint": {
      "platform": "dify",
      "api_key": "invalid-key-format"
    }
  }'
```

**期望响应**：
```json
{
  "detail": "Dify API Key 格式错误，必须以 'app-' 开头"
}
```
**状态码**：422

##### 3b. 连通性测试失败

**请求**：
```bash
curl -X POST "http://localhost:3000/api/v1/dev/integrations" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "测试工具",
    "type": "http",
    "endpoint": {
      "platform": "dify",
      "api_key": "app-wrongkey123456"
    }
  }'
```

**期望响应**：
```json
{
  "detail": "连通性测试失败: Invalid API key"
}
```
**状态码**：400

**前端处理**：
```javascript
try {
  const response = await fetch('/api/v1/dev/integrations', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(integrationData)
  });
  
  if (!response.ok) {
    const error = await response.json();
    
    if (response.status === 422) {
      showError('参数错误: ' + error.detail);
    } else if (response.status === 400) {
      showError('连接失败: ' + error.detail);
    }
    return;
  }
  
  const data = await response.json();
  showSuccess('集成创建成功！');
  
} catch (error) {
  showError('网络错误: ' + error.message);
}
```

---

#### Step 4: 测试已创建的集成

**请求**：
```bash
INTEGRATION_ID=101

curl -X POST "http://localhost:3000/api/v1/dev/integrations/$INTEGRATION_ID/test" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "test_data": {
      "query": "你好，请介绍一下你的功能"
    }
  }'
```

**期望响应**：
```json
{
  "success": true,
  "result": "您好！我是智能客服助手，可以帮助您解答...",
  "execution_time": 1.23,
  "timestamp": "2025-10-14T03:45:00Z"
}
```

---

#### Step 5: 获取集成列表

**请求**：
```bash
curl "http://localhost:3000/api/v1/dev/integrations" \
  -H "Authorization: Bearer $TOKEN"
```

**期望响应**：
```json
{
  "items": [
    {
      "id": 101,
      "tool_id": "dify_1697270123_a1b2c3d4",
      "name": "客服助手",
      "type": "http",
      "status": "active",
      "created_at": "2025-10-14T03:42:00Z"
    },
    {
      "id": 102,
      "tool_id": "coze_1697270456_e5f6g7h8",
      "name": "FAQ 问答助手",
      "type": "http",
      "status": "active",
      "created_at": "2025-10-14T03:44:00Z"
    }
  ],
  "total": 2,
  "page": 1,
  "size": 20
}
```

---

#### Step 6: 删除集成

**请求**：
```bash
TOOL_ID="dify_1760493974_e287da4e"

curl -X DELETE "http://localhost:3000/api/v1/dev/tools/$TOOL_ID/" \
  -H "Authorization: Bearer $TOKEN"
```

**期望响应（成功删除）**：
```json
{
  "message": "工具删除成功"
}
```
**状态码**：200 或 204

**期望响应（工具不存在）**：
```json
{
  "detail": "工具不存在"
}
```
**状态码**：404

**前端处理**：
```javascript
async function deleteIntegration(toolId) {
  try {
    const token = localStorage.getItem('token');
    
    const response = await fetch(`http://localhost:3000/api/v1/dev/tools/${toolId}/`, {
      method: 'DELETE',
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });
    
    if (response.ok) {
      showSuccess('工具删除成功');
      await refreshIntegrationList(); // 刷新列表
    } else {
      const error = await response.json();
      showError('删除失败: ' + error.detail);
    }
    
  } catch (error) {
    showError('删除请求失败: ' + error.message);
  }
}
```

---

### 完整前端示例代码

```javascript
// 场景二：开发者创建 API 集成
async function createIntegration(formData) {
  try {
    const token = localStorage.getItem('token');
    
    // 构造请求数据
    const requestData = {
      name: formData.name,
      type: 'http',
      description: formData.description,
      endpoint: {
        platform: formData.platform, // 'dify' or 'coze'
        api_key: formData.apiKey
      }
    };
    
    // 如果是 Coze，添加 bot_id
    if (formData.platform === 'coze') {
      requestData.endpoint.app_config = {
        bot_id: formData.botId
      };
    }
    
    // 1. 创建集成
    const response = await fetch('http://localhost:3000/api/v1/dev/integrations', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(requestData)
    });
    
    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.detail || '创建失败');
    }
    
    const data = await response.json();
    
    // 2. 显示成功信息
    showSuccess(`
      集成创建成功！
      - 名称: ${data.name}
      - Tool ID: ${data.tool_id}
      - 状态: ${data.status}
    `);
    
    // 3. 可选：立即测试集成
    const shouldTest = await confirm('是否立即测试该集成？');
    if (shouldTest) {
      await testIntegration(data.id);
    }
    
    // 4. 刷新集成列表
    await refreshIntegrationList();
    
  } catch (error) {
    console.error('创建集成失败:', error);
    showError(error.message);
  }
}

// 测试集成
async function testIntegration(integrationId) {
  try {
    const token = localStorage.getItem('token');
    const testQuery = prompt('请输入测试查询:', '你好，请介绍一下你的功能');
    
    if (!testQuery) return;
    
    const response = await fetch(`http://localhost:3000/api/v1/dev/integrations/${integrationId}/test`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        test_data: { query: testQuery }
      })
    });
    
    const data = await response.json();
    
    if (data.success) {
      showSuccess(`
        测试成功！
        - 响应: ${data.result}
        - 耗时: ${data.execution_time}秒
      `);
    } else {
      showError('测试失败: ' + data.error);
    }
    
  } catch (error) {
    showError('测试请求失败: ' + error.message);
  }
}

// 获取集成列表
async function refreshIntegrationList() {
  try {
    const token = localStorage.getItem('token');
    
    const response = await fetch('http://localhost:3000/api/v1/dev/integrations', {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });
    
    const data = await response.json();
    
    // 渲染列表
    renderIntegrationList(data.items);
    
  } catch (error) {
    console.error('获取列表失败:', error);
  }
}
```

---

## 🎯 验收标准

### 场景一：语音交互
- ✅ 用户能成功登录并获取 token
- ✅ 简单问候能得到直接回答
- ✅ 工具调用请求能正确解析意图
- ✅ 用户确认后能成功执行工具
- ✅ 用户拒绝后能正确取消操作
- ✅ 所有返回的文本能正确语音播报

### 场景二：API 集成
- ✅ 开发者能成功登录并获取 developer 权限
- ✅ Dify 集成能成功创建（正确的 API Key）
- ✅ Coze 集成能成功创建（正确的 API Key 和 Bot ID）
- ✅ 错误的 API Key 格式能被正确拦截（422）
- ✅ 无效的 API Key 能在连通性测试时失败（400）
- ✅ 创建成功后能立即测试集成
- ✅ 能正确获取和显示集成列表
- ✅ 能成功删除已创建的集成（使用 tool_id）
- ✅ 删除不存在的集成时返回 404 错误

---

## 🔧 调试技巧

### 查看详细响应

```bash
# 添加 -v 参数查看完整请求和响应
curl -v -X POST "http://localhost:3000/api/v1/intent/interpret" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"query": "测试", "session_id": null, "user_id": 13}'
```

### 格式化 JSON 输出

```bash
# 使用 jq 格式化输出
curl ... | jq '.'

# 或使用 python
curl ... | python3 -m json.tool
```

### 检查 Token 有效性

```bash
# 解码 JWT token（不验证签名）
echo "YOUR_TOKEN" | cut -d'.' -f2 | base64 -d | jq '.'
```

---

## 📞 常见问题

**Q: 401 错误怎么办？**  
A: Token 过期或无效，重新登录获取新 token

**Q: 403 错误怎么办？**  
A: 权限不足，确认使用了正确角色的账号（场景二需要 developer）

**Q: 422 错误怎么办？**  
A: 参数格式错误，检查请求体是否符合规范

**Q: 创建集成时连通性测试失败？**  
A: 检查 API Key 是否正确，是否有网络访问 Dify/Coze 的权限

---

> **文档版本**: v1.0 (2025-10-14)  
> **适用人群**: 前端开发者  
> **相关文档**: [前后端对接与API规范](./前后端对接与API规范.md)

